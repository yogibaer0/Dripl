<!doctype html>
<html lang="en">
<head>
  <!-- Content Security Policy -->
<!-- Pragmatic, permissive CSP for Ameba (friendly + safe enough) -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self' https:;
  object-src 'none';
  base-uri 'self';

  /* allow your app + CDNs + WASM/Workers */
  script-src
    'self' https:
    'unsafe-inline' 'unsafe-eval'        /* keeps things convenient */
    blob:;
  worker-src 'self' blob:;
  child-src blob:;                        /* old browsers fallback */

  style-src
    'self' https:
    'unsafe-inline';                      /* allow inline styles */

  img-src
    'self' https: data: blob:;

  font-src
    'self' https: data:;

  media-src
    'self' https: blob: data:;            /* video/audio previews + ffmpeg */

  /* XHR/Fetch/WebSocket endpoints your app talks to */
  connect-src
    'self' https: http://localhost:8080 ws://localhost:8080
   https://dripl.onrender.com
    https://ujchypvlqzermgpfzaqo.supabase.co
    https://api.dropboxapi.com https://content.dropboxapi.com
    https://www.googleapis.com https://*.googleusercontent.com;

  /* OAuth / Picker iframes/popups (Drive, Dropbox, etc.) */
  frame-src
    https://accounts.google.com
    https://*.google.com https://*.googleusercontent.com
    https://www.dropbox.com;

  /* explicitly allow common CDNs (optional, belt & suspenders) */
  script-src-elem 'self' https: 'unsafe-inline';
  style-src-elem  'self' https: 'unsafe-inline';
">


</head>
<body>
  <!-- Corner brand -->
  <a class="corner" href="#" aria-label="Home">
    <img class="corner__logo" src="assets/dripl/dripl.png" alt="logo" />
    <span class="corner__name" id="appName">Dripl</span>
    <span class="corner__badge">beta</span>
  </a>

  <!-- Hero -->
  <header class="hero">
    <img class="hero__logo" src="assets/dripl/dripl.png" alt="" />
    <h1 class="hero__title" id="heroTitle">Dripl</h1>
    <div class="glow-line">
      <svg viewBox="0 0 100 2" preserveAspectRatio="none">
        <path d="M0,1 L100,1" stroke="url(#g)" stroke-width="2" fill="none" />
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0" stop-color="#8b5cf6"/>
            <stop offset="1" stop-color="#a78bfa"/>
          </linearGradient>
        </defs>
      </svg>
    </div>
  </header>

  <main class="panels">

    <!-- Upload -->
    <section class="card" id="uploadPanel">
      <div class="card__head">
        <div class="card__head__left">
          <span class="icon">üíß</span>
          <h2>Upload</h2>
        </div>
      </div>

      <div class="upload">
        <div id="uploadDrop"
             class="dropzone"
             aria-label="Drag & drop files here">
          <span class="dropzone__hint">
            <strong>Drag &amp; drop files here</strong>
            <em>‚Ä¶or drop a link / text</em>
          </span>
        </div>

        <div class="upload__controls">
          <input id="pasteLink" class="input" type="text"
                 placeholder="Paste link (YouTube, TikTok, etc.)" />
          <select id="formatSelect" class="select">
            <option value="mp4">MP4 (video)</option>
            <option value="mp3">MP3 (audio)</option>
          </select>
          <button id="convertBtn" class="btn btn--primary">Convert</button>
        </div>

        <p class="muted">Pro tip: press <kbd>Enter</kbd> to convert instantly.</p>
      </div>
    </section>

    <!-- Import -->
    <section class="card" id="importPanel">
      <div class="card__head">
        <div class="card__head__left">
          <span class="icon">üåê</span>
          <h2>Import</h2>
        </div>
      </div>

      <div class="import">
        <div class="import__col">
  <h3>This device</h3>

  <!-- One button the user clicks -->
  <button id="importChooseBtn" class="btn" data-action="choose-files" type="button">
    Choose files
  </button>

  <!-- The real file input lives offscreen -->
  <input id="importFileInput" type="file" multiple
         style="position:absolute; left:-9999px; width:1px; height:1px;" />
</div>

        <div class="import__col">
          <h3>Dropbox</h3>
          <button id="connectDropbox" class="btn">Connect Dropbox</button>
          <p class="muted">Direct links, multi-select</p>
        </div>

        <div class="import__col">
          <h3>Google Drive</h3>
          <button id="connectDrive" class="btn">Connect Google Drive</button>
          <p class="muted">Picker with OAuth</p>
        </div>
      </div>
    </section>

    <!-- Storage -->
    <section class="card" id="storagePanel">
      <div class="card__head">
        <div class="card__head__left">
          <span class="icon">üíæ</span>
          <h2>Storage</h2>
        </div>

        <div class="toolbar">
          <div class="search">
            <input id="storageSearch" type="search"
                   placeholder="Search by file name, tags, notes, or source‚Ä¶" />
            <button id="storageClearSearch" class="icon-btn" aria-label="Clear">‚úï</button>
          </div>

          <button id="btnAddFolder" class="btn">+ Folder</button>
          <button id="btnFilters" class="btn">Filters ‚ñæ</button>
          <button id="btnPresets" class="btn">Presets ‚ñæ</button>
        </div>
      </div>

      <div class="tabs">
        <button class="chip chip--active" data-tab="recent" id="tabRecent">Recent</button>
        <button class="chip" data-tab="saved" id="tabSaved">Saved ‚òÖ</button>
        <button class="chip" data-tab="queue" id="tabQueue">In progress</button>
        <button class="chip" data-tab="shared" id="tabShared">Shared with me</button>
        <button class="chip" data-tab="trash" id="tabTrash">Trash</button>
      </div>

      <div id="storageList" class="grid"></div>
<a class="btn btn--ghost" href="{{downloadUrl}}" download="{{name}}">Download</a>
    </section>

  </main>

  <!-- Popovers (Filters / Presets / New Folder) -->
  <section id="filterPanel" class="popover" hidden>
    <header>Filters</header>
    <form id="filterForm" class="stack">
      <fieldset>
        <legend>Type</legend>
        <div class="chips">
          <button type="button" class="chip" data-key="type" data-val="video">Video</button>
          <button type="button" class="chip" data-key="type" data-val="audio">Audio</button>
        </div>
      </fieldset>

      <fieldset>
        <legend>Quality</legend>
        <div class="chips">
          <button type="button" class="chip" data-key="quality" data-val="high">High</button>
          <button type="button" class="chip" data-key="quality" data-val="medium">Medium</button>
          <button type="button" class="chip" data-key="quality" data-val="low">Low</button>
        </div>
      </fieldset>

      <div class="grid grid--2">
        <label>Format <input name="format" type="text" placeholder="mp4/mp3/webm"/></label>
        <label>Source <input name="source" type="text" placeholder="youtube/tiktok/drive‚Ä¶"/></label>
        <label>Meta   <input name="meta"   type="text" placeholder="notes/tags‚Ä¶"/></label>
        <label>Min size (MB) <input name="minSize" type="number" min="0"/></label>
        <label>Max size (MB) <input name="maxSize" type="number" min="0"/></label>
      </div>

      <div class="row end">
        <button id="filterClear" type="button" class="btn btn--ghost">Clear</button>
        <button type="submit" class="btn btn--primary">Apply</button>
      </div>
    </form>
  </section>

  <section id="presetPanel" class="popover" hidden>
    <header>Presets</header>
    <div id="presetList" class="stack"></div>
    <div class="row">
      <input id="presetName" class="input" placeholder="Preset name" />
      <button id="presetSave" class="btn btn--primary">Save current</button>
    </div>
  </section>

  <section id="folderPanel" class="popover" hidden>
    <header>New folder</header>
    <div class="row">
      <input id="folderName" class="input" placeholder="Folder name" />
      <button id="folderCreate" class="btn btn--primary">Create</button>
    </div>
  </section>

<!-- Supabase config (read by script.js) -->
<meta name="supabase-url" content="https://ujchypvlqzermgpfzaqo.supabase.co">
<meta name="supabase-anon" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVqY2h5cHZscXplcm1ncGZ6YXFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzNzA3NzQsImV4cCI6MjA3NTk0Njc3NH0.WHWxl2VReNQrjlnSlIjyagLpWLex6vmKI0KpXX6_i1w">



<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

<!-- FFmpeg loader (local) -->
<script type="module" src="ffmpeg-loader.js" defer></script>
<script type="module">
  import { FFmpeg } from '/vendor/ffmpeg/ffmpeg.mjs';
  import * as FFUtil from '/vendor/ffmpeg/util.mjs';

  async function ensureFFmpeg() {
    if (window.ffmpegReady) return window.ffmpeg;

    const ffmpeg = new FFmpeg();
    await ffmpeg.load({
      coreURL:   '/vendor/ffmpeg/ffmpeg-core.js',
      wasmURL:   '/vendor/ffmpeg/ffmpeg-core.wasm',
      workerURL: '/vendor/ffmpeg/ffmpeg-core.worker.js',
    });

    window.ffmpegReady = true;
    window.ffmpeg = ffmpeg;
    return ffmpeg;
  }

  // Example: small pre-transcode to reduce downstream upload size
  window.preTranscodeToMP4 = async (file) => {
    const ffmpeg = await ensureFFmpeg();

    // Write input
    await ffmpeg.writeFile('in', new Uint8Array(await file.arrayBuffer()));

    // Transcode lightweight (copy audio, h264 video, capped bitrate)
    await ffmpeg.exec([
      '-i', 'in',
      '-c:v', 'libx264', '-preset', 'veryfast', '-b:v', '1500k',
      '-c:a', 'aac', '-b:a', '128k',
      'out.mp4'
    ]);

    const data = await ffmpeg.readFile('out.mp4'); // Uint8Array
    return new File([data.buffer], 'pretranscoded.mp4', { type: 'video/mp4' });
  };
</script>

<!-- App code -->
<script src="script.js" defer></script>
</body>
</html>














