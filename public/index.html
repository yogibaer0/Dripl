<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AMEBA</title>

  <!-- ===== Config (injected by server.ts) ===== -->
  <meta name="supabase-url" content="{{SUPABASE_URL}}">
  <meta name="supabase-anon-key" content="{{SUPABASE_ANON_KEY}}">
  <meta name="api-base" content="{{API_BASE}}">
  <meta name="page-nonce" content="{{NONCE}}">

  <!-- ===== Styles ===== -->
  <link rel="stylesheet" href="/styles.css" />

  <!-- ===== Security: local UMD + CSP nonce ===== -->
  <script {{SUPABASE_SRI_ATTR}} src="/vendor/supabase.min.js" nonce="{{NONCE}}"></script>

  <!-- Bootstrap config for JS -->
  <script nonce="{{NONCE}}">
    (function () {
      const meta = (n) => document.querySelector(`meta[name="${n}"]`)?.content?.trim() || "";
      window.__APP__ = {
        NONCE: meta("page-nonce"),
        API_BASE: meta("api-base") || "",
        SUPABASE_URL: meta("supabase-url"),
        SUPABASE_ANON_KEY: meta("supabase-anon-key")
      };
    }());
  </script>
</head>

<body>
  <header class="hero">
    <h1 class="hero__title">AMEBA</h1>
    <div class="glow-line">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 10" preserveAspectRatio="none">
        <path d="M0,5 Q200,0 400,5" stroke="#8b5cf6" stroke-width="2" fill="none" opacity=".3"/>
      </svg>
    </div>
  </header>

  <!-- Hidden input for local picker (must not be display:none) -->
  <label for="fileInput" class="sr-only">Choose a file</label>
  <input id="fileInput" type="file" accept="video/*,image/*" aria-hidden="true" />

  <main class="shell open-space-shell">
    <!-- NEW LAYOUT: Open Space Shell -->
    
    <!-- TOP WALL: Destination Hub (moved from bottom, reused as-is) -->
    <div class="top-wall" id="topWall">
      <!-- Destination Hub (moved to top-wall) -->
      <section class="panel--dest panel--dest-topwall" aria-label="Destination Hub">
        <!-- Hub card (the cell) -->
        <section class="card dest-card">
          <div class="card__head">
            <h2 class="hidden">Destination Hub</h2>
          </div>

          <div class="card__body">
            <!-- Hub content wrapper to constrain width -->
            <div class="dest-inner">
              <section id="destHub"
                       class="dest-panel"
                       aria-label="Preview, metadata and actions">

                <div class="dest-left">
                  <div class="preview-wrap" id="previewWrap" aria-live="polite">
                    <img id="previewImg" alt="" hidden>
                    <video id="previewVideo" playsinline muted loop controls hidden></video>

                    <div class="preview-hint" id="previewHint">
                      <span>Preview</span>
                      <span class="muted">‚Ä¢ 1:1 ‚Ä¢ drag a file above or paste a link</span>
                    </div>
                  </div>
                </div>

                <div class="dest-right">
                  <div class="meta-grid" role="list">
                    <div class="meta-row" role="listitem">
                      <span id="lblMetaFilename" class="meta-label">Filename</span>
                      <div class="pill" id="metaFilename" role="text" aria-labelledby="lblMetaFilename">‚Äî</div>
                    </div>

                    <div class="meta-row" role="listitem">
                      <span id="lblMetaDuration" class="meta-label">Duration</span>
                      <div class="pill" id="metaDuration" role="text" aria-labelledby="lblMetaDuration">‚Äî</div>
                    </div>

                    <div class="meta-row" role="listitem">
                      <span id="lblMetaResolution" class="meta-label">Resolution</span>
                      <div class="pill" id="metaResolution" role="text" aria-labelledby="lblMetaResolution">‚Äî</div>
                    </div>

                    <div class="meta-row" role="listitem">
                      <span id="lblMetaCodec" class="meta-label">Codec</span>
                      <div class="pill" id="metaCodec" role="text" aria-labelledby="lblMetaCodec">‚Äî</div>
                    </div>
                  </div>

                  <div class="dest-actions">
                    <!-- Ghost buttons (mirror satellites) -->
                    <div class="dest-buttons">
                      <button class="btn btn-ghost" data-target="tiktok">TikTok</button>
                      <button class="btn btn-ghost" data-target="instagram">Instagram</button>
                      <button class="btn btn-ghost" data-target="youtube">YouTube</button>
                      <button class="btn btn-ghost" data-target="reddit">Reddit</button>
                    </div>

                    <!-- SR-only labels kept for a11y -->
                    <label class="sr-only" for="optWatermark">Watermark</label>
                    <label class="sr-only" for="optAutotrim">Auto-trim</label>
                    <label class="sr-only" for="optAutofit">Auto-fit to platform</label>
                    <label class="sr-only" for="optFaceFilters">Face filters</label>

                    <div class="dest-toggles">
                      <label class="toggle"><input type="checkbox" id="optWatermark" /> <span>Watermark</span></label>
                      <label class="toggle"><input type="checkbox" id="optAutotrim" /> <span>Auto-trim</span></label>
                      <label class="toggle"><input type="checkbox" id="optAutofit" /> <span>Auto-fit to platform</span></label>
                      <label class="toggle"><input type="checkbox" id="optFaceFilters" /> <span>Face filters</span></label>
                    </div>

                    <button id="convertSelected" class="btn btn--primary">Convert Selected</button>
                  </div>
                </div>
              </section>
            </div>

            <!-- Return button stays with the hub UI -->
            <button class="sat-return" id="satReturn" hidden>Return</button>
          </div>
        </section>

        <!-- Proteins: satellites live OUTSIDE the card, in their own rail -->
        <div class="dest-sat-rail" aria-hidden="true">
          <button class="satellite sat--yt"
                  data-platform="youtube" data-slot-index="0"
                  aria-pressed="false" aria-label="YouTube" title="YouTube"></button>

          <button class="satellite sat--ig"
                  data-platform="instagram" data-slot-index="1"
                  aria-pressed="false" aria-label="Instagram" title="Instagram"></button>

          <button class="satellite sat--tt"
                  data-platform="tiktok" data-slot-index="2"
                  aria-pressed="false" aria-label="TikTok" title="TikTok"></button>

          <button class="satellite sat--rd"
                  data-platform="reddit" data-slot-index="3"
                  aria-pressed="false" aria-label="Reddit" title="Reddit"></button>
        </div>
      </section>
      <!-- END Destination Hub -->
    </div>
    
    <!-- CENTER: Open Space Viewport (no panel background) -->
    <div class="open-space-viewport" id="openSpaceViewport">
      <!-- Default: User stats placeholders -->
      <div class="open-space-content" id="openSpaceContent">
        <div class="user-stats-placeholder">
          <div class="stat-widget">
            <span class="stat-label">Followers</span>
            <span class="stat-value">‚Äî</span>
          </div>
          <div class="stat-widget">
            <span class="stat-label">Likes</span>
            <span class="stat-value">‚Äî</span>
          </div>
          <div class="stat-widget">
            <span class="stat-label">Emails</span>
            <span class="stat-value">‚Äî</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- LEFT: Vanity/Tool Bubble -->
    <div class="vanity-bubble" id="vanityBubble" role="button" tabindex="0" aria-label="Tool shed">
      <div class="vanity-bubble__avatar">
        <!-- User profile image placeholder -->
        <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
          <circle cx="12" cy="8" r="4" fill="currentColor" opacity="0.8"/>
          <path d="M4 20c0-4.4 3.6-8 8-8s8 3.6 8 8" fill="currentColor" opacity="0.6"/>
        </svg>
      </div>
      
      <!-- Tool shed panel (hidden by default) -->
      <div class="tool-shed" id="toolShed" hidden>
        <div class="tool-shed__title">Tool Shed</div>
        <div class="tool-shed__items">
          <button class="tool-item" data-tool="dripl-engine">
            <span class="tool-item__icon">‚öôÔ∏è</span>
            <span class="tool-item__label">Dripl Engine</span>
          </button>
          <button class="tool-item" data-tool="ameba-quality">
            <span class="tool-item__icon">‚ú®</span>
            <span class="tool-item__label">AMEBA Quality+</span>
          </button>
          <button class="tool-item" data-tool="batch-process">
            <span class="tool-item__icon">üì¶</span>
            <span class="tool-item__label">Batch Process</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- BOTTOM: Bottom Dock (Port + Storage) -->
    <div class="bottom-dock" id="bottomDock">
      <div class="bottom-dock__content">
        <div class="dock-section dock-section--port">
          <h3 class="dock-section__title">Port</h3>
          <div class="dock-section__actions">
            <button class="dock-btn" id="dockUpload" title="Upload files">
              <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                <path fill="currentColor" d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/>
              </svg>
              <span>Upload</span>
            </button>
            <button class="dock-btn" id="dockImport" title="Import from sources">
              <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                <path fill="currentColor" d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/>
              </svg>
              <span>Import</span>
            </button>
            <button class="dock-btn" id="dockConvert" title="Convert media">
              <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                <path fill="currentColor" d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/>
              </svg>
              <span>Convert</span>
            </button>
          </div>
        </div>
        <div class="dock-section dock-section--storage">
          <button class="dock-btn dock-btn--storage" id="dockStorage" title="Open Storage">
            <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
              <path fill="currentColor" d="M4 7.5c0-1.1.9-2 2-2h3.2c.3 0 .6.1.8.3l1 1c.2.2.5.3.8.3H18c1.1 0 2 .9 2 2v7.7c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V7.5Z"/>
            </svg>
            <span>Storage</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- RIGHT: Analytics Wall (slide-out) -->
    <aside class="analytics-wall" id="analyticsWall" aria-label="Analytics panel">
      <button class="analytics-wall__handle" id="analyticsToggle" aria-label="Toggle analytics panel">
        <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
          <path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
        </svg>
      </button>
      
      <div class="analytics-wall__content">
        <div class="analytics-section">
          <h3 class="analytics-section__title">Analytics</h3>
          <div class="analytics-section__body">
            <p class="muted small">Performance metrics will appear here</p>
          </div>
        </div>
        
        <div class="analytics-section">
          <h3 class="analytics-section__title">Sticky Notes</h3>
          <div class="analytics-section__body">
            <p class="muted small">Pin notes into open space</p>
          </div>
        </div>
        
        <div class="analytics-section">
          <h3 class="analytics-section__title">Calendar</h3>
          <div class="analytics-section__body">
            <p class="muted small">Schedule and deadlines</p>
          </div>
        </div>
      </div>
    </aside>

    <!-- LEGACY PANELS (preserved but hidden/repositioned) -->
    <div class="legacy-panels" hidden>
      <!-- Upload -->
      <section class="card panel--upload upload" aria-labelledby="h-upload">
        <div class="card__head"><h2 id="h-upload">Upload</h2></div>
        <div class="card__body">
          <div class="dropzone" id="dropzone" aria-label="Drop files here">
            <div class="dropzone__hint">
              <p>Drag &amp; drop files here or paste a link below</p>
            </div>
          </div>

          <div class="upload__controls">
            <label for="paste-input" class="sr-only">Paste media link</label>
            <input id="paste-input" class="input" placeholder="Paste media link‚Ä¶" />
            <select id="format" class="select" aria-label="Output format">
              <option value="mp4">MP4 (video)</option>
              <option value="mp3">MP3 (audio)</option>
              <option value="gif">GIF</option>
            </select>
            <button id="convert-btn" class="btn btn--primary" aria-label="Convert">Convert</button>
          </div>

          <p class="muted">Tip: press <kbd>Enter</kbd> to convert instantly.</p>
        </div>
      </section>

      <!-- Import -->
      <section class="card panel--import import" aria-labelledby="h-import">
        <div class="card__head"><h2 id="h-import">Import</h2></div>
        <div class="card__body">
          <div class="goo-container">
            <svg class="goo-bg" viewBox="0 0 1000 320" preserveAspectRatio="none">
              <path id="importGoo" d="M0,140 Q500,210 1000,140 L1000,320 L0,320 Z"></path>
            </svg>

            <!-- icons inside the goo -->
            <div class="icon-row" role="group" aria-label="Import sources">
              <button class="import-icon" id="imp-device"  aria-label="This device" title="This device">
                <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                  <path fill="currentColor"
                        d="M4 7.5c0-1.1.9-2 2-2h3.2c.3 0 .6.1.8.3l1 1c.2.2.5.3.8.3H18c1.1 0 2 .9 2 2v7.7c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V7.5Z"/>
                  <path d="M4 10h16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </button>

              <button class="import-icon" id="imp-dropbox" aria-label="Dropbox" title="Dropbox">
                <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                  <path fill="currentColor"
                        d="M7.5 3.5 12 6l-4.5 2.5L3 6l4.5-2.5Zm9 0L21 6l-4.5 2.5L12 6l4.5-2.5ZM7.5 11.5 12 14l-4.5 2.5L3 14l4.5-2.5Zm13.5 2.5-4.5 2.5L12 14l4.5-2.5L21 14Zm-9 2.6 3.6 2.1-3.6 2.1L8.4 18.6 12 16.6Z"/>
                </svg>
              </button>

              <button class="import-icon" id="imp-drive" aria-label="Google Drive" title="Google Drive">
                <svg viewBox="0 0 24 24" class="icon" aria-hidden="true">
                  <polygon fill="#FBBC04" points="10,4 14,4 20,14 16,14"/>
                  <polygon fill="#34A853" points="10,4 4,14 8,14 14,4"/>
                  <polygon fill="#4285F4" points="8,14 12,20 20,14 16,14 12,18"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Storage -->
      <section class="card panel--storage storage" aria-labelledby="h-storage">
        <div class="card__head">
          <h2 id="h-storage">Storage</h2>
          <div class="toolbar">
            <button class="btn secondary" type="button">+ Folder</button>
            <button class="btn secondary" type="button">Filters</button>
            <button class="btn secondary" type="button">Presets</button>
          </div>
        </div>

        <div class="card__body storage-body">
          <!-- Search row -->
          <div class="storage__search-row">
            <div class="storage__search">
              <input
                id="storage-search"
                type="text"
                placeholder="Search files, tags, notes‚Ä¶"
                aria-label="Search files, tags, notes"
              />
            </div>
          </div>

                    <!-- Plumes (1‚Äì4 buttons) -->
          <div class="storage-plumes" role="list">
            <!-- 1. Recent conversions (dropdown DOWN) -->
            <div class="storage-plume-wrap storage-plume-wrap--recent">
              <button
                class="storage-plume storage-plume--recent"
                data-section="recent"
                type="button"
                role="listitem"
              >
                <div class="plume-labels">
                  <span class="plume-title">Recent conversions</span>
                  <span class="plume-subtitle">See what you just converted</span>
                </div>
                <div class="plume-previews" id="recent-previews" aria-hidden="true">
                  <!-- thumbnails injected by JS -->
                </div>
              </button>

              <!-- Recent dropdown list -->
              <div class="storage-dropdown storage-dropdown--recent">
                <div class="storage-dropdown__title">Recent files</div>
                <div class="storage-dropdown__list" id="storageRecentList">
                  <!-- compact rows injected by JS -->
                </div>
              </div>
            </div>

            <!-- 2. Library (no dropdown ‚Äì uses big content area + engulf) -->
            <div class="storage-plume-wrap storage-plume-wrap--library">
              <button
                class="storage-plume storage-plume--library"
                data-section="library"
                type="button"
                role="listitem"
              >
                <div class="plume-labels">
                  <span class="plume-title">Library</span>
                  <span class="plume-subtitle">Saved, pinned &amp; favorites</span>
                </div>
                <div class="plume-orbit" aria-hidden="true">
                  <span class="plume-orb orb-1"></span>
                  <span class="plume-orb orb-2"></span>
                  <span class="plume-orb orb-3"></span>
                  <span class="plume-orb orb-4"></span>
                  <span class="plume-orb orb-5"></span>
                  <span class="plume-orb orb-6"></span>
                  <span class="plume-orb orb-7"></span>
                  <span class="plume-orb orb-8"></span>
                </div>
              </button>
            </div>

            <!-- 3. Queued (dropdown UP) -->
            <div class="storage-plume-wrap storage-plume-wrap--queue">
              <!-- Queue dropdown (sits visually above the plume) -->
              <div class="storage-dropdown storage-dropdown--queue">
                <div class="storage-dropdown__title">Queue</div>
                <div class="storage-dropdown__list" id="storageQueueList">
                  <p class="muted small">No active conversions.</p>
                </div>
              </div>

              <button
                class="storage-plume storage-plume--queue"
                data-section="queue"
                type="button"
                role="listitem"
              >
                <div class="plume-labels">
                  <span class="plume-title">Queued</span>
                  <span class="plume-subtitle">In progress &amp; upcoming</span>
                </div>
                <div class="plume-bubbles" aria-hidden="true">
                  <span></span><span></span><span></span><span></span>
                </div>
              </button>
            </div>

            <!-- 4. Shared -->
            <div class="storage-plume-wrap storage-plume-wrap--shared">
              <button
                class="storage-plume storage-plume--shared"
                data-section="shared"
                type="button"
                role="listitem"
              >
                <div class="plume-labels">
                  <span class="plume-title">Shared with me</span>
                  <span class="plume-subtitle">Team links &amp; collab</span>
                </div>
              </button>
            </div>
          </div>

          <!-- Content area driven by which plume is active -->
          <div class="storage__content" id="storageContent">
            <!-- Recent = uses existing storage list -->
            <div class="storage__section storage__section--recent is-visible">
              <div class="grid" id="storage-list"></div>
            </div>

           <div class="storage__section storage__section--library">
  <div class="library-layout library-layout--list">
    <!-- Vertical list (limited view; scroll for more) -->
    <div class="library-list-wrapper" aria-label="Library items">
      <div class="library-list" id="libraryList"></div>
    </div>

    <!-- Slide-in details panel (covers most of gradient window, not all) -->
    <aside class="library-details-panel" id="libraryDetailsPanel" aria-hidden="true">
      <div class="library-details-panel__head">
        <div class="library-details-panel__label">DETAILS</div>
        <button
          class="library-details-panel__close"
          id="libraryDetailsClose"
          type="button"
          aria-label="Close details"
        >√ó</button>
      </div>
      <div class="library-details-panel__body" id="libraryDetailsBody">
        <p class="muted small">Select a clip or folder to see metadata.</p>
      </div>
    </aside>
  </div>

  <p class="library-empty muted">
    Your Ameba library will collect saved &amp; pinned items here.
  </p>
</div>


            <!-- Queue placeholder -->
            <div class="storage__section storage__section--queue">
              <p class="muted">Queued conversions will show up here with progress soon.</p>
            </div>

            <!-- Shared placeholder -->
            <div class="storage__section storage__section--shared">
              <p class="muted">Links shared with you will live here.</p>
            </div>
          </div>
        </div>
      </section>
    </div>
    <!-- END legacy-panels (hidden) -->

  </main>

  <script src="/script.js" nonce="{{NONCE}}"></script>

  <!-- small dropzone glow helper; keep or move into script.js -->
  <script nonce="{{NONCE}}">
    (function(){
      const dz = document.getElementById('dropzone'); if (!dz) return;
      const on = (t, fn) => dz.addEventListener(t, fn, false);
      const stop = (e) => { e.preventDefault(); e.stopPropagation(); };
      on('dragenter', e => { stop(e); dz.classList.add('dropzone--over'); });
      on('dragover',  e => { stop(e); dz.classList.add('dropzone--over'); });
      on('dragleave', e => { stop(e); dz.classList.remove('dropzone--over'); });
      on('drop',      e => {
        stop(e);
        dz.classList.remove('dropzone--over'); dz.classList.add('dropzone--absorbing');
        setTimeout(()=>dz.classList.remove('dropzone--absorbing'), 600);
      });
    }());
    
    // Initialize Ameba components
    if (typeof window.AmebaInit === 'function') {
      try {
        window.AmebaInit();
      } catch (e) {
        console.error('[ameba] Initialization error:', e);
      }
    }
  </script>
</body>
</html>
























